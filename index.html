<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Cat√°logo Interactivo con Login/Registro</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{--accent:#007bff;--green-effect:rgba(0,200,0,0.28);}
*{box-sizing:border-box;}
body{margin:0;padding:0;font-family:Arial,sans-serif;}
button{cursor:pointer;}
#login-section{display:flex;justify-content:center;align-items:center;height:100vh;padding:20px;}
#login-box{background:white;padding:25px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.12);width:350px;}
#login-box h2{text-align:center;margin-bottom:18px;}
#login-box input{width:100%;margin-bottom:10px;padding:10px;border-radius:6px;border:1px solid #ccc;font-size:15px;}
#login-box button{width:100%;background:var(--accent);color:white;padding:10px;border:none;border-radius:6px;margin-top:6px;}
#login-box button:hover{background:#0056b3;}
#login-box .toggle-login{margin-top:12px;text-align:center;cursor:pointer;color:var(--accent);text-decoration:underline;font-size:14px;}
body.logged #login-section{display:none;}
body.logged #main-section{display:flex;gap:20px;padding:20px;}
#main{flex:3;min-width:0;padding:0 10px;}
#sidebar{flex:1;background:white;padding:15px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);position:sticky;top:20px;max-height:90vh;overflow-y:auto;transition:transform 0.3s;}
#busqueda,#categoria-filtro{display:block;margin:10px auto;padding:12px;font-size:16px;border-radius:8px;border:1px solid #ccc;width:92%;max-width:820px;}
#catalogo{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-top:10px;}
.producto{background:white;border-radius:12px;padding:14px;box-shadow:0 4px 10px rgba(0,0,0,0.06);display:flex;flex-direction:column;align-items:center;transition:transform .18s;}
.producto:hover{transform:translateY(-6px);}
.producto img{width:150px;height:150px;object-fit:cover;border-radius:8px;margin-bottom:10px;display:block;}
.producto .info{text-align:center;margin-bottom:10px;}
.acciones{display:flex;gap:8px;align-items:center;}
.producto input[type="number"]{width:64px;padding:6px;text-align:center;border-radius:6px;border:1px solid #ccc;}
.producto button{padding:8px 12px;background:var(--accent);color:#fff;border:none;border-radius:8px;}
.producto button:hover{background:#0056b3;}
#carrito ul{list-style:none;padding:0;margin:0;}
#carrito li{padding:6px 0;border-bottom:1px solid #eee;font-size:14px;}
#total{text-align:right;font-weight:700;margin-top:10px;color:var(--accent);}
#enviar-pedido-btn{display:block;text-align:center;margin-top:12px;background:#16a34a;color:white;padding:12px 10px;border-radius:8px;text-decoration:none;font-weight:700;}
#sidebar input,#sidebar select,#sidebar textarea{width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;font-size:15px;box-sizing:border-box;margin-bottom:10px;}
.fly-wrapper{position:absolute;z-index:9999;width:120px;height:120px;border-radius:50%;display:flex;align-items:center;justify-content:center;overflow:hidden;background:var(--green-effect);
box-shadow:0 8px 20px rgba(0,0,0,0.18);transition:left .95s cubic-bezier(.22,1,.36,1),top .95s cubic-bezier(.22,1,.36,1),
width .95s cubic-bezier(.22,1,.36,1),height .95s cubic-bezier(.22,1,.36,1),opacity .6s ease;pointer-events:none;}
.fly-wrapper img{width:78%;height:auto;border-radius:8px;object-fit:cover;transition:width .95s,height .95s,transform .95s;display:block;}
.costo-envio {margin-top: 10px;padding: 10px;background-color: #f0f8ff;border-radius: 6px;border: 1px solid #d0e8ff;font-size: 14px;}
.costo-envio.calculando {background-color: #fff8e1;border-color: #ffecb3;}
.costo-envio.error {background-color: #ffeaea;border-color: #ffcdd2;}
.required-field::after {content: " *";color: red;}

/* Estilos para el letrero deslizante */
#info-envio {
  position: fixed;
  top: 0;
  left: -100%;
  width: 100%;
  background: linear-gradient(90deg, #007bff, #0056b3);
  color: white;
  padding: 12px 20px;
  text-align: center;
  font-size: 14px;
  z-index: 10000;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  transition: left 0.5s ease-in-out;
}

#info-envio.mostrar {
  left: 0;
}

#cerrar-info {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: white;
  font-size: 18px;
  cursor: pointer;
}

/* Mejoras adicionales */
#carrito-vacio {
  text-align: center;
  color: #888;
  font-style: italic;
  padding: 10px;
}

#carrito-items {
  max-height: 200px;
  overflow-y: auto;
  margin-bottom: 10px;
}

/* Estilo mejorado para el costo de env√≠o */
.costo-envio-mejorado {
  margin-top: 15px;
  padding: 15px;
  border-radius: 10px;
  font-size: 16px;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  border: 2px solid #e1e8f0;
  transition: all 0.3s ease;
}

.costo-envio-mejorado.calculando {
  background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
  border-color: #ffd54f;
  animation: pulse 1.5s infinite;
}

.costo-envio-mejorado.error {
  background: linear-gradient(135deg, #ffeaea 0%, #ffcdd2 100%);
  border-color: #e57373;
}

.costo-envio-mejorado .titulo-envio {
  font-weight: bold;
  font-size: 18px;
  margin-bottom: 8px;
  color: #2c3e50;
}

.costo-envio-mejorado .valor-envio {
  font-size: 22px;
  font-weight: bold;
  color: #16a34a;
  margin-bottom: 5px;
}

.costo-envio-mejorado .distancia-envio {
  font-size: 14px;
  color: #7f8c8d;
  margin-bottom: 5px;
}

.costo-envio-mejorado .tiempo-envio {
  font-size: 12px;
  color: #95a5a6;
  font-style: italic;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.02); }
  100% { transform: scale(1); }
}

/* Indicador de validaci√≥n de direcci√≥n */
.input-error {
  border-color: #e74c3c !important;
  box-shadow: 0 0 5px rgba(231, 76, 60, 0.5) !important;
}

.input-ok {
  border-color: #2ecc71 !important;
  box-shadow: 0 0 5px rgba(46, 204, 113, 0.5) !important;
}

.validacion-direccion {
  font-size: 12px;
  margin-top: -8px;
  margin-bottom: 10px;
  padding: 5px;
  border-radius: 4px;
  display: none;
}

.validacion-direccion.error {
  display: block;
  background-color: #ffeaea;
  color: #e74c3c;
  border: 1px solid #ffcdd2;
}

.validacion-direccion.ok {
  display: block;
  background-color: #e8f5e9;
  color: #2ecc71;
  border: 1px solid #c8e6c9;
}

@media(max-width:900px){
  body.logged #main-section{flex-direction:column;}
  #main,#sidebar{width:100%;}
  #sidebar{position:relative;top:auto;max-height:none;overflow:visible;}
  #busqueda,#categoria-filtro{width:96%;}
  #info-envio {
    font-size: 12px;
    padding: 10px 15px;
  }
}
</style>
</head>
<body>

<!-- Letrero deslizante con informaci√≥n de env√≠o -->
<div id="info-envio">
  <span>El costo de env√≠o se aplicar√° si el importe de su carrito no supera los $20.000. Nuestra direcci√≥n: Pasaje Guernica 1615, Tandil, Buenos Aires, Argentina.</span>
  <button id="cerrar-info">√ó</button>
</div>

<section id="login-section">
  <div id="login-box">
    <h2 id="login-title">Login</h2>
    <input type="text" id="usuario-input" placeholder="Usuario" required>
    <input type="password" id="password-input" placeholder="Contrase√±a" required>
    <input type="text" id="nombre-input" placeholder="Nombre Completo" style="display:none;" required>
    <input type="text" id="telefono-input" placeholder="Tel√©fono" style="display:none;" required>
    <button id="login-btn">Ingresar</button>
    <div class="toggle-login" id="toggle-login">Crear cuenta</div>
  </div>
</section>

<section id="main-section" style="display:none;">
  <div id="main">
    <div id="logo-empresa" style="text-align:center;margin-bottom:12px;">
      <img src="./logo.png" alt="logo" style="max-width:220px;width:100%;height:auto;">
    </div>
    <input type="text" id="busqueda" placeholder="Buscar producto...">
    <select id="categoria-filtro"><option value="Todas">Todas las categor√≠as</option></select>
    <div id="catalogo">Cargando productos...</div>
  </div>

  <div id="sidebar">
    <section>
      <h2>Datos de entrega y pago</h2>
      <label for="direccion-entrega" class="required-field">Direcci√≥n de entrega</label>
      <input type="text" id="direccion-entrega" placeholder="Ej: Uriburu 147" required>
      <div id="validacion-direccion" class="validacion-direccion"></div>
      <label for="localidad-entrega" class="required-field">Localidad</label>
      <select id="localidad-entrega">
        <option value="">Selecciona tu localidad</option>
        <!-- Las localidades se cargar√°n din√°micamente -->
      </select>
      <input type="text" id="referencia-entrega" placeholder="Referencia (opcional)">
      <select id="metodo-pago">
        <option value="Efectivo">Efectivo</option>
        <option value="Transferencia">Transferencia</option>
        <option value="Debito">D√©bito</option>
      </select>
      <textarea id="observaciones" rows="3" placeholder="Observaciones del pedido"></textarea>
      <div id="costo-envio" class="costo-envio-mejorado" style="display:none;">
        <div class="titulo-envio">Costo de env√≠o</div>
        <div class="valor-envio" id="valor-envio">$0</div>
        <div class="distancia-envio" id="distancia-envio"></div>
        <div class="tiempo-envio" id="tiempo-envio"></div>
      </div>
    </section>

    <h2>üõí Carrito</h2>
    <div id="carrito-items">
      <div id="carrito-vacio">Tu carrito est√° vac√≠o</div>
      <ul id="carrito"></ul>
    </div>
    <!-- Mostrar solo el costo de env√≠o, ocultar el total -->
    <div id="total" style="display:none;"></div>
    <a id="enviar-pedido-btn" href="#">Enviar pedido</a>
  </div>
</section>

<script>
// üîê DATOS SENSIBLES - Se llenar√°n autom√°ticamente en Vercel
const SHEET_ID = '1NLPpVF7eNUXYc1xnmLA2ecLWQJL7hSOytdvZktwNIEg';
const URL_SCRIPT_CREAR_USUARIO = 'https://script.google.com/macros/s/AKfycbxhkQrjzmMkNt8y1-7xrg2788quKOOQLRjOL9IIFmhJsjirQRbcoeYMetbvOK95BHhJIg/exec';
const URL_SCRIPT_PEDIDO = 'https://script.google.com/macros/s/AKfycbwy6VcLxNKTMO9ZgAnOWUNfOSm4CFjarJGp9S6HjFgOFphbl9T21y--53hcwcxiDtIWSg/exec';


// URLs que se generan autom√°ticamente
const SHEET_URL = `https://opensheet.elk.sh/${SHEET_ID}/1`;
const SHEET_PRODUCTOS = `https://opensheet.elk.sh/${SHEET_ID}/Productos`;

// API Key de Google Maps
const GOOGLE_MAPS_API_KEY = 'AIzaSyD28MYISEZGkCh1tnTe4NrYC4fpcjnICmA';

// Direcci√≥n de origen para calcular env√≠os
const DIRECCION_ORIGEN = 'Pasaje Guernica 1615, Tandil, Provincia de Buenos Aires, Argentina';

let productosGlobal=[], carrito=[], usersCache=[], productosPrecios=[];
let telefonoUsuario = ""; // tel√©fono del cliente logueado
let costoEnvio = 0; // costo de env√≠o calculado
let costoEnvioCalculado = false; // Para evitar recalcular
let direccionActual = ""; // Para comparar si cambi√≥ la direcci√≥n
let localidadActual = ""; // Para comparar si cambi√≥ la localidad

const catalogoDiv=document.getElementById('catalogo');
const carritoUl=document.getElementById('carrito');
const carritoVacioDiv=document.getElementById('carrito-vacio');
const categoriaFiltro=document.getElementById('categoria-filtro');
const direccionInput=document.getElementById('direccion-entrega');
const validacionDireccionDiv=document.getElementById('validacion-direccion');
const localidadSelect=document.getElementById('localidad-entrega');
const referenciaInput=document.getElementById('referencia-entrega');
const metodoPagoSelect=document.getElementById('metodo-pago');
const observacionesInput=document.getElementById('observaciones');
const busquedaInput=document.getElementById('busqueda');
const enviarPedidoBtn=document.getElementById('enviar-pedido-btn');
const costoEnvioDiv=document.getElementById('costo-envio');
const valorEnvioSpan=document.getElementById('valor-envio');
const distanciaEnvioSpan=document.getElementById('distancia-envio');
const tiempoEnvioSpan=document.getElementById('tiempo-envio');

const loginSection=document.getElementById('login-section');
const mainSection=document.getElementById('main-section');
const loginTitle=document.getElementById('login-title');
const toggleLogin=document.getElementById('toggle-login');
const usuarioInput=document.getElementById('usuario-input');
const passwordInput=document.getElementById('password-input');
const nombreInput=document.getElementById('nombre-input');
const telefonoInput=document.getElementById('telefono-input');
const loginBtn=document.getElementById('login-btn');

// Elementos del letrero deslizante
const infoEnvioDiv = document.getElementById('info-envio');
const cerrarInfoBtn = document.getElementById('cerrar-info');

// Mostrar letrero deslizante al cargar la p√°gina
window.addEventListener('load', () => {
  setTimeout(() => {
    infoEnvioDiv.classList.add('mostrar');
  }, 1000);
});

// Cerrar letrero deslizante
cerrarInfoBtn.addEventListener('click', () => {
  infoEnvioDiv.classList.remove('mostrar');
});

// Lista de localidades de Buenos Aires
const localidadesBuenosAires = [
  "Tandil", "Azul", "Olavarr√≠a", "Necochea", "Mar del Plata", "Bah√≠a Blanca", "La Plata",
  "Luj√°n", "San Nicol√°s", "Z√°rate", "Campana", "Pergamino", "Jun√≠n", "Chivilcoy",
  "Mercedes", "Chacabuco", "9 de Julio", "Bragado", "General Pico", "Trenque Lauquen",
  "Pehuaj√≥", "Carlos Casares", "Bol√≠var", "Daireaux", "25 de Mayo", "Saladillo",
  "Roque P√©rez", "Lobos", "Ca√±uelas", "San Vicente", "Alejandro Korn", "Brandsen",
  "Monte", "Ranchos", "General Paz", "Las Flores", "Rauch", "Ayacucho", "Tandil",
  "Benito Ju√°rez", "Laprida", "Coronel Su√°rez", "Saavedra", "Pig√º√©", "Tornquist",
  "Coronel Pringles", "Coronel Dorrego", "Balcarce", "Lober√≠a", "San Cayetano",
  "Necochea", "Lober√≠a", "Mar del Plata", "General Pueyrred√≥n", "Villa Gesell",
  "Pinamar", "General Madariaga", "Dolores", "Chascom√∫s", "Lezama", "Castelli",
  "Pila", "General Guido", "Maip√∫", "General Alvarado", "Miramar", "General Lavalle",
  "La Costa", "San Clemente del Tuy√∫", "Santa Teresita", "Mar de Aj√≥", "General Belgrano",
  "Brandsen", "Chascom√∫s", "Lezama", "Castelli", "Pila", "General Guido", "Dolores",
  "Tordillo", "General Lavalle", "La Costa", "Vicente L√≥pez", "San Isidro", "San Fernando",
  "Tigre", "Malvinas Argentinas", "Jos√© C. Paz", "Pilar", "Escobar", "Moreno",
  "Merlo", "Ituzaing√≥", "Hurlingham", "Mor√≥n", "Tres de Febrero", "San Mart√≠n",
  "Vicente L√≥pez", "San Isidro", "San Fernando", "Tigre", "Malvinas Argentinas",
  "Jos√© C. Paz", "Pilar", "Escobar", "Moreno", "Merlo", "Ituzaing√≥", "Hurlingham",
  "Mor√≥n", "Tres de Febrero", "San Mart√≠n", "La Matanza", "Ezeiza", "Esteban Echeverr√≠a",
  "Almirante Brown", "Quilmes", "Berazategui", "Florencio Varela", "Avellaneda",
  "Lan√∫s", "Lomas de Zamora", "La Plata", "Berisso", "Ensenada", "Brandsen",
  "Ca√±uelas", "San Vicente", "Alejandro Korn", "General Paz", "Las Flores", "Rauch",
  "Ayacucho", "Tandil", "Benito Ju√°rez", "Laprida", "Coronel Su√°rez", "Saavedra",
  "Pig√º√©", "Tornquist", "Coronel Pringles", "Coronel Dorrego", "Balcarce", "Lober√≠a",
  "San Cayetano", "Necochea", "Lober√≠a", "Mar del Plata", "General Pueyrred√≥n",
  "Villa Gesell", "Pinamar", "General Madariaga", "Dolores", "Chascom√∫s", "Lezama",
  "Castelli", "Pila", "General Guido", "Maip√∫", "General Alvarado", "Miramar",
  "General Lavalle", "La Costa", "San Clemente del Tuy√∫", "Santa Teresita", "Mar de Aj√≥"
];

/* Validar formato de direcci√≥n */
function validarDireccion(direccion) {
  // Verificar que la direcci√≥n tenga al menos una letra y un n√∫mero
  const tieneLetras = /[a-zA-Z]/.test(direccion);
  const tieneNumeros = /\d/.test(direccion);
  
  // Verificar que tenga al menos 5 caracteres
  const longitudMinima = direccion.trim().length >= 5;
  
  return tieneLetras && tieneNumeros && longitudMinima;
}

/* Render cat√°logo SIN precios */
function renderCatalogo(productos){
  catalogoDiv.innerHTML='';
  productos.forEach(p=>{
    const div=document.createElement('div'); div.className='producto';
    div.innerHTML=`<img src="${p.imagen}" alt="${p.nombre}">
    <div class="info"><strong>${p.nombre}</strong><br><small>${p.categoria}</small></div>
    <div class="acciones">
      <input type="number" id="cant-${p.nombre}" value="1" min="1">
      <button>Agregar</button>
    </div>`;
    catalogoDiv.appendChild(div);
    const button = div.querySelector('button');
    button.addEventListener('click',()=>agregarAlCarrito(p, button));
  });
}

/* Render carrito */

/* Render carrito */
function renderCarrito(){
  carritoUl.innerHTML='';
  let totalProductos = 0;
  
  if (carrito.length === 0) {
    carritoVacioDiv.style.display = 'block';
    enviarPedidoBtn.style.display = 'none';
  } else {
    carritoVacioDiv.style.display = 'none';
    enviarPedidoBtn.style.display = 'block';
    
    carrito.forEach(item=>{
      const prodPrecio = productosPrecios.find(p=>p.nombre===item.nombre);
      const precio = prodPrecio ? parseFloat(prodPrecio.precio) : 0;
      totalProductos += precio * item.cantidad;
      const li=document.createElement('li');
      li.textContent=`${item.nombre} x${item.cantidad}`;
      carritoUl.appendChild(li);
    });
  }
  
  const totalConEnvio = totalProductos + costoEnvio;
  
  // Ocultar el total al cliente, pero mantenerlo para el c√°lculo interno
  document.getElementById('total').innerHTML = `
    <div>Subtotal: $${totalProductos.toFixed(2)}</div>
    <div>Env√≠o: $${costoEnvio.toFixed(2)}</div>
    <div style="font-size: 1.2em; margin-top: 5px;">Total: $${totalConEnvio.toFixed(2)}</div>
  `;
  
  // AGREGAR ESTA L√ìGICA NUEVA:
  // Mostrar "ENV√çO GRATIS" si el total supera $20,000
  if (totalProductos >= 20000 && costoEnvioCalculado) {
    costoEnvioDiv.style.display = 'block';
    costoEnvioDiv.className = 'costo-envio-mejorado';
    valorEnvioSpan.textContent = "¬°ENV√çO GRATIS!";
    distanciaEnvioSpan.textContent = "Tu pedido supera los $20.000";
    tiempoEnvioSpan.textContent = "üéâ Aprovecha esta promoci√≥n";
  }
  // Mostrar costo normal si es menor a $20,000
  else if (costoEnvio > 0 && costoEnvioCalculado) {
    costoEnvioDiv.style.display = 'block';
  } else {
    costoEnvioDiv.style.display = 'none';
  }
}

/*function renderCarrito(){
  carritoUl.innerHTML='';
  let totalProductos = 0;
  
  if (carrito.length === 0) {
    carritoVacioDiv.style.display = 'block';
    enviarPedidoBtn.style.display = 'none';
  } else {
    carritoVacioDiv.style.display = 'none';
    enviarPedidoBtn.style.display = 'block';
    
    carrito.forEach(item=>{
      const prodPrecio = productosPrecios.find(p=>p.nombre===item.nombre);
      const precio = prodPrecio ? parseFloat(prodPrecio.precio) : 0;
      totalProductos += precio * item.cantidad;
      const li=document.createElement('li');
      li.textContent=`${item.nombre} x${item.cantidad}`;
      carritoUl.appendChild(li);
    });
  }
  
  const totalConEnvio = totalProductos + costoEnvio;
  
  // Ocultar el total al cliente, pero mantenerlo para el c√°lculo interno
  document.getElementById('total').innerHTML = `
    <div>Subtotal: $${totalProductos.toFixed(2)}</div>
    <div>Env√≠o: $${costoEnvio.toFixed(2)}</div>
    <div style="font-size: 1.2em; margin-top: 5px;">Total: $${totalConEnvio.toFixed(2)}</div>
  `;
  
  // Mostrar solo el costo de env√≠o al cliente
  if (costoEnvio > 0 && costoEnvioCalculado) {
    costoEnvioDiv.style.display = 'block';
  } else {
    costoEnvioDiv.style.display = 'none';
  }
}*/

/* Agregar al carrito + efecto vuelo */
function agregarAlCarrito(producto, button){
  const input=document.getElementById(`cant-${producto.nombre}`);
  const cantidad=parseInt(input.value)||1;
  const existente=carrito.find(p=>p.nombre===producto.nombre);
  if(existente) existente.cantidad+=cantidad;
  else carrito.push({...producto,cantidad});
  renderCarrito();

  const rect = button.getBoundingClientRect();
  const fly=document.createElement('div'); fly.className='fly-wrapper';
  const imgClone=document.createElement('img'); imgClone.src=producto.imagen;
  fly.appendChild(imgClone); document.body.appendChild(fly);

  fly.style.left = (rect.left + window.scrollX) + 'px';
  fly.style.top  = (rect.top + window.scrollY) + 'px';
  fly.style.width = rect.width + 'px';
  fly.style.height = rect.height + 'px';

  setTimeout(()=>{
    const target = carritoUl.getBoundingClientRect();
    fly.style.left = (target.left + window.scrollX) + 'px';
    fly.style.top  = (target.top + window.scrollY) + 'px';
    fly.style.width='30px'; fly.style.height='30px'; fly.style.opacity='0.3';
    imgClone.style.width='30px';
  },50);

  setTimeout(()=>{fly.remove();},900);
}

/* Filtros */
function filtrar(){
  const val=busquedaInput.value.toLowerCase();
  const cat=categoriaFiltro.value.toLowerCase();
  let filtrados=productosGlobal.filter(p=>p.nombre.toLowerCase().includes(val));
  if(cat!=='todas') filtrados=filtrados.filter(p=>p.categoria.toLowerCase()===cat);
  renderCatalogo(filtrados);
}
categoriaFiltro.addEventListener('change',filtrar);
busquedaInput.addEventListener('input',filtrar);

/* Cargar localidades en el select */
function cargarLocalidades() {
  // Ordenar localidades alfab√©ticamente
  const localidadesOrdenadas = [...new Set(localidadesBuenosAires)].sort();
  
  localidadesOrdenadas.forEach(localidad => {
    const option = document.createElement('option');
    option.value = localidad;
    option.textContent = localidad;
    localidadSelect.appendChild(option);
  });
}

/* Calcular costo de env√≠o usando Google Maps Distance Matrix API */
async function calcularCostoEnvio(direccion, localidad) {
  // Validar direcci√≥n antes de calcular
  if (!validarDireccion(direccion)) {
    validacionDireccionDiv.textContent = "Por favor, ingresa una direcci√≥n v√°lida (ej: Uriburu 147)";
    validacionDireccionDiv.className = "validacion-direccion error";
    direccionInput.classList.add("input-error");
    direccionInput.classList.remove("input-ok");
    
    costoEnvio = 0;
    costoEnvioCalculado = false;
    costoEnvioDiv.style.display = 'none';
    renderCarrito();
    return;
  }
  
  // Si ya calculamos para esta direcci√≥n y localidad, no recalcular
  if (costoEnvioCalculado && direccion === direccionActual && localidad === localidadActual) {
    return;
  }
  
  // Guardar la direcci√≥n y localidad actuales
  direccionActual = direccion;
  localidadActual = localidad;
  
  const direccionCompleta = `${direccion}, ${localidad}, Provincia de Buenos Aires, Argentina`;
  
  // Mostrar estado de c√°lculo
  costoEnvioDiv.className = 'costo-envio-mejorado calculando';
  costoEnvioDiv.style.display = 'block';
  valorEnvioSpan.textContent = 'Calculando...';
  distanciaEnvioSpan.textContent = '';
  tiempoEnvioSpan.textContent = 'Calculando con precisi√≥n...';
  
  // Mostrar validaci√≥n exitosa
  validacionDireccionDiv.textContent = "‚úì Direcci√≥n v√°lida";
  validacionDireccionDiv.className = "validacion-direccion ok";
  direccionInput.classList.remove("input-error");
  direccionInput.classList.add("input-ok");
  
  try {
    // INTENTO 1: Usar JSONP como alternativa a CORS
    await calcularConJSONP(direccionCompleta);
    
  } catch (error1) {
    console.error('Error con JSONP:', error1);
    
    try {
      // INTENTO 2: Usar nuestro propio proxy simple
      await calcularConProxySimple(direccionCompleta);
      
    } catch (error2) {
      console.error('Error con proxy simple:', error2);
      
      try {
        // INTENTO 3: Usar otro proxy p√∫blico
        await calcularConProxyPublico(direccionCompleta);
        
      } catch (error3) {
        console.error('Error con proxy p√∫blico:', error3);
        
        // INTENTO 4: C√°lculo aproximado basado en coordenadas conocidas
        calcularCostoAproximado(localidad, direccionCompleta);
      }
    }
  }
}

/* INTENTO 1: Usar JSONP para evitar CORS */
function calcularConJSONP(direccionCompleta) {
  return new Promise((resolve, reject) => {
    const callbackName = 'googleMapsCallback_' + Date.now();
    
    window[callbackName] = function(data) {
      // Limpiar
      document.getElementById('jsonpScript').remove();
      delete window[callbackName];
      
      if (data.status === 'OK' && data.rows[0].elements[0].status === 'OK') {
        procesarDistancia(data);
        resolve();
      } else {
        reject(new Error('Error en respuesta JSONP'));
      }
    };
    
    const script = document.createElement('script');
    script.id = 'jsonpScript';
    script.src = `https://maps.googleapis.com/maps/api/distancematrix/json?origins=${encodeURIComponent(DIRECCION_ORIGEN)}&destinations=${encodeURIComponent(direccionCompleta)}&key=${GOOGLE_MAPS_API_KEY}&callback=${callbackName}`;
    
    script.onerror = () => {
      document.getElementById('jsonpScript')?.remove();
      delete window[callbackName];
      reject(new Error('Error cargando JSONP'));
    };
    
    document.head.appendChild(script);
    
    // Timeout despu√©s de 15 segundos (m√°s tiempo para mayor precisi√≥n)
    setTimeout(() => {
      if (document.getElementById('jsonpScript')) {
        document.getElementById('jsonpScript').remove();
        delete window[callbackName];
        reject(new Error('Timeout JSONP'));
      }
    }, 20000);
  });
}

/* INTENTO 2: Proxy simple usando Google Apps Script */
async function calcularConProxySimple(direccionCompleta) {
  // Crear un proxy simple usando fetch sin CORS
  const proxyUrl = `https://script.google.com/macros/s/AKfycbyT3N7C3X6Q7X9X8X7X6X5X4X3X2X1X0X/exec?origins=${encodeURIComponent(DIRECCION_ORIGEN)}&destinations=${encodeURIComponent(direccionCompleta)}&key=${GOOGLE_MAPS_API_KEY}`;
  
  const response = await fetch(proxyUrl);
  const data = await response.json();
  
  if (data.status === 'OK' && data.rows[0].elements[0].status === 'OK') {
    procesarDistancia(data);
  } else {
    throw new Error('Error en proxy simple');
  }
}

/* INTENTO 3: Usar proxy p√∫blico alternativo */
async function calcularConProxyPublico(direccionCompleta) {
  const proxyUrl = 'https://api.allorigins.win/raw?url=';
  const apiUrl = `https://maps.googleapis.com/maps/api/distancematrix/json?origins=${encodeURIComponent(DIRECCION_ORIGEN)}&destinations=${encodeURIComponent(direccionCompleta)}&key=${GOOGLE_MAPS_API_KEY}`;
  
  const response = await fetch(proxyUrl + encodeURIComponent(apiUrl));
  const data = await response.json();
  
  if (data.status === 'OK' && data.rows[0].elements[0].status === 'OK') {
    procesarDistancia(data);
  } else {
    throw new Error('Error en proxy p√∫blico');
  }
}

/* Procesar la distancia obtenida de la API */
function procesarDistancia(data) {
  const distancia = data.rows[0].elements[0].distance.value; // en metros
  const tiempo = data.rows[0].elements[0].duration.value; // en segundos
  const distanciaKm = distancia / 1000;
  const tiempoMinutos = Math.ceil(tiempo / 60);
  
  // Calcular costo basado en distancia: $1000 por km
  costoEnvio = 1000 * distanciaKm;
  
  // Costo m√≠nimo de $500 para distancias muy cortas
  if (costoEnvio < 500) {
    costoEnvio = 500;
  }
  
  // Marcar como calculado
  costoEnvioCalculado = true;
  
  // Mostrar costo de env√≠o
  costoEnvioDiv.className = 'costo-envio-mejorado';
  valorEnvioSpan.textContent = `$${costoEnvio.toFixed(2)}`;
  distanciaEnvioSpan.textContent = `${distanciaKm.toFixed(1)} km desde nuestra ubicaci√≥n`;
  tiempoEnvioSpan.textContent = `Tiempo estimado: ${tiempoMinutos} minutos`;
  
  // Actualizar total
  renderCarrito();
}

/* C√°lculo aproximado de costo de env√≠o basado en localidad */
function calcularCostoAproximado(localidad, direccionCompleta) {
  // Distancias aproximadas desde Tandil (en km)
  const distanciasAproximadas = {
    'tandil': 5,
    'azul': 110,
    'olavarr√≠a': 180,
    'necochea': 300,
    'mar del plata': 350,
    'bah√≠a blanca': 400,
    'la plata': 320,
    'luj√°n': 350,
    'san nicol√°s': 380,
    'z√°rate': 400,
    'campana': 420,
    'pergamino': 300,
    'jun√≠n': 250,
    'chivilcoy': 280,
    'mercedes': 300,
    'chacabuco': 280,
    '9 de julio': 230,
    'bragado': 260,
    'general pico': 400,
    'trenque lauquen': 350,
    'pehuaj√≥': 320,
    'carlos casares': 300,
    'bol√≠var': 200,
    'daireaux': 250,
    '25 de mayo': 280,
    'saladillo': 220,
    'roque p√©rez': 260,
    'lobos': 290,
    'ca√±uelas': 320,
    'san vicente': 340,
    'alejandro korn': 330,
    'brandsen': 320,
    'monte': 300,
    'ranchos': 280,
    'general paz': 260,
    'las flores': 240,
    'rauch': 80,
    'ayacucho': 100,
    'benito ju√°rez': 120,
    'laprida': 140,
    'coronel su√°rez': 180,
    'saavedra': 200,
    'pig√º√©': 220,
    'tornquist': 240,
    'coronel pringles': 260,
    'coronel dorrego': 280,
    'balcarce': 120,
    'lober√≠a': 150,
    'san cayetano': 180,
    'general pueyrred√≥n': 350,
    'villa gesell': 400,
    'pinamar': 420,
    'general madariaga': 380,
    'dolores': 320,
    'chascom√∫s': 280,
    'lezama': 260,
    'castelli': 240,
    'pila': 220,
    'general guido': 200,
    'maip√∫': 180,
    'general alvarado': 160,
    'miramar': 140,
    'general lavalle': 120,
    'la costa': 100,
    'san clemente del tuy√∫': 80,
    'santa teresita': 70,
    'mar de aj√≥': 60,
    'general belgrano': 200,
    'tordillo': 180,
    'vicente l√≥pez': 350,
    'san isidro': 340,
    'san fernando': 330,
    'tigre': 320,
    'malvinas argentinas': 310,
    'jos√© c. paz': 300,
    'pilar': 290,
    'escobar': 280,
    'moreno': 270,
    'merlo': 260,
    'ituzaing√≥': 250,
    'hurlingham': 240,
    'mor√≥n': 230,
    'tres de febrero': 220,
    'san mart√≠n': 210,
    'la matanza': 200,
    'ezeiza': 190,
    'esteban echeverr√≠a': 180,
    'almirante brown': 170,
    'quilmes': 160,
    'berazategui': 150,
    'florencio varela': 140,
    'avellaneda': 130,
    'lan√∫s': 120,
    'lomas de zamora': 110,
    'berisso': 100,
    'ensenada': 90
  };
  
  const localidadLower = localidad.toLowerCase();
  let distanciaKm = 50; // Distancia por defecto
  
  // Buscar coincidencia
  for (const [zona, distancia] of Object.entries(distanciasAproximadas)) {
    if (localidadLower.includes(zona) || zona.includes(localidadLower)) {
      distanciaKm = distancia;
      break;
    }
  }
  
  // Calcular costo: $1000 por km
  costoEnvio = 1000 * distanciaKm;
  
  // Marcar como calculado
  costoEnvioCalculado = true;
  
  costoEnvioDiv.className = 'costo-envio-mejorado';
  valorEnvioSpan.textContent = `$${costoEnvio.toFixed(2)}`;
  distanciaEnvioSpan.textContent = `${distanciaKm} km aproximado desde nuestra ubicaci√≥n`;
  tiempoEnvioSpan.textContent = "Tiempo estimado: c√°lculo aproximado";
  renderCarrito();
}

/* Fetch productos */
fetch(SHEET_URL)
.then(r=>r.json())
.then(data=>{
  productosGlobal=data;
  renderCatalogo(productosGlobal);
  [...new Set(productosGlobal.map(p=>p.categoria))].forEach(cat=>{
    const option=document.createElement('option');
    option.value=cat; option.textContent=cat;
    categoriaFiltro.appendChild(option);
  });
});

/* Fetch precios reales desde Productos */
fetch(SHEET_PRODUCTOS)
.then(r=>r.json())
.then(data=>{productosPrecios=data;});

/* Enviar pedido con precios reales y tel√©fono */
/* Enviar pedido con precios reales y tel√©fono */
enviarPedidoBtn.addEventListener("click", async e=>{
  e.preventDefault();
  if(carrito.length===0){alert("El carrito est√° vac√≠o");return;}
  
  // Validar direcci√≥n obligatoria
  if(!direccionInput.value.trim()) {
    alert("Por favor, ingresa tu direcci√≥n de entrega");
    direccionInput.focus();
    return;
  }
  
  // Validar formato de direcci√≥n
  if(!validarDireccion(direccionInput.value)) {
    alert("Por favor, ingresa una direcci√≥n v√°lida (ej: Uriburu 147)");
    direccionInput.focus();
    return;
  }
  
  // Validar localidad seleccionada
  if(!localidadSelect.value) {
    alert("Por favor, selecciona tu localidad");
    localidadSelect.focus();
    return;
  }

  const productosFormateados = carrito.map(item=>{
    const prodPrecio = productosPrecios.find(p=>p.nombre===item.nombre);
    const precio = prodPrecio ? parseFloat(prodPrecio.precio) : 0;
    return `${item.nombre} x${item.cantidad} ($${precio.toFixed(2)} c/u)`;
  }).join(" | ");

  const totalProductos = carrito.reduce((s,item)=>{
    const prodPrecio = productosPrecios.find(p=>p.nombre===item.nombre);
    const precio = prodPrecio ? parseFloat(prodPrecio.precio) : 0;
    return s + precio*item.cantidad;
  },0);

  // AGREGAR ESTA L√ìGICA NUEVA:
  // Determinar si se aplica costo de env√≠o (solo si el total de productos es menor a $20,000)
  const costoEnvioFinal = totalProductos < 20000 ? costoEnvio : 0;
  const totalFinal = totalProductos + costoEnvioFinal;

  const fecha = new Date().toLocaleString('es-AR');

  const params=new URLSearchParams({
    fecha: fecha,
    usuario: usuarioInput.value||"Invitado",
    productos: productosFormateados,
    direccion: direccionInput.value||"Sin direcci√≥n",
    localidad: localidadSelect.value||"Sin localidad",
    referencia: referenciaInput.value||"Sin referencia",
    metodoPago: metodoPagoSelect.value,
    observaciones: observacionesInput.value||"Ninguna",
    totalProductos: totalProductos.toFixed(2),
    costoEnvio: costoEnvioFinal.toFixed(2), // ‚Üê Usar costoEnvioFinal en lugar de costoEnvio
    total: totalFinal.toFixed(2), // ‚Üê Usar totalFinal en lugar de totalConEnvio
    telefono: telefonoUsuario
  });

  const loader = document.createElement('div');
  loader.textContent = 'Enviando pedido...';
  loader.style.position='fixed';
  loader.style.top='50%';
  loader.style.left='50%';
  loader.style.transform='translate(-50%,-50%)';
  loader.style.background='rgba(0,0,0,0.8)';
  loader.style.color='white';
  loader.style.padding='20px';
  loader.style.borderRadius='12px';
  loader.style.zIndex='9999';
  document.body.appendChild(loader);

  fetch(URL_SCRIPT_PEDIDO+"?"+params.toString())
    .then(r=>r.json())
    .then(res=>{
      loader.remove();
      if(res.success){
        // Mostrar mensaje informativo si no se aplic√≥ el costo de env√≠o
        if(totalProductos >= 20000) {
          alert("‚úÖ Pedido enviado correctamente\n\nüéâ ¬°Env√≠o gratis! Tu pedido supera los $20.000");
        } else {
          alert("‚úÖ Pedido enviado correctamente");
        }
        carrito=[];
        costoEnvio = 0;
        costoEnvioCalculado = false;
        costoEnvioDiv.style.display = 'none';
        renderCarrito();
      }
      else alert("‚ùå Error: "+res.error);
    })
    .catch(err=>{loader.remove(); alert("‚ùå Error de conexi√≥n: "+err);});
});

/* Login / Registro */
toggleLogin.addEventListener('click',()=>{
  if(loginTitle.textContent==='Login'){
    loginTitle.textContent='Registro'; loginBtn.textContent='Crear cuenta';
    nombreInput.style.display='block'; telefonoInput.style.display='block';
  } else {
    loginTitle.textContent='Login'; loginBtn.textContent='Ingresar';
    nombreInput.style.display='none'; telefonoInput.style.display='none';
  }
});

loginBtn.addEventListener('click',()=>{
  if(loginTitle.textContent==='Login'){
    fetch(`https://opensheet.elk.sh/${SHEET_ID}/Usuarios`)
      .then(r=>r.json())
      .then(data=>{
        usersCache=data;
        const user=usersCache.find(u=>u.Usuario===usuarioInput.value && u.Contrase√±a===passwordInput.value);
        if(user){
          if(parseInt(user.Presupuestos || 0) > 3){
            alert("‚ùå Has excedido el l√≠mite de presupuestos. No puedes entrar."); return;
          }
          telefonoUsuario = user.Telefono || ""; // Guardamos tel√©fono
          document.body.classList.add('logged'); mainSection.style.display='flex';
          
          // Cargar localidades despu√©s del login
          cargarLocalidades();
        } else alert('Usuario o contrase√±a incorrectos');
      })
      .catch(err=>{console.error(err); alert('Error al conectar con la base de usuarios');});
  } else {
    if(!usuarioInput.value || !passwordInput.value || !nombreInput.value || !telefonoInput.value){
      alert('Completa todos los campos'); return;
    }
    telefonoUsuario = telefonoInput.value; // guardamos tel√©fono nuevo usuario

    const loader = document.createElement('div');
    loader.textContent = 'Creando usuario...';
    loader.style.position='fixed';
    loader.style.top='50%';
    loader.style.left='50%';
    loader.style.transform='translate(-50%,-50%)';
    loader.style.background='rgba(0,0,0,0.8)';
    loader.style.color='white';
    loader.style.padding='20px';
    loader.style.borderRadius='12px';
    loader.style.zIndex='9999';
    document.body.appendChild(loader);

    const formData=new FormData();
    formData.append('Usuario',usuarioInput.value);
    formData.append('Contrase√±a',passwordInput.value);
    formData.append('Nombre',nombreInput.value);
    formData.append('Telefono',telefonoInput.value);
    fetch(URL_SCRIPT_CREAR_USUARIO,{method:'POST',body:formData})
      .then(r=>r.json())
      .then(res=>{
        loader.remove();
        alert(res.message);
        if(res.success){
          document.body.classList.add('logged'); mainSection.style.display='flex';
          loginTitle.textContent='Login'; loginBtn.textContent='Ingresar';
          nombreInput.style.display='none'; telefonoInput.style.display='none';
          
          // Cargar localidades despu√©s del registro
          cargarLocalidades();
        }
      }).catch(()=>{loader.remove(); alert('Error al crear usuario');});
  }
});

// Event listeners para calcular env√≠o cuando cambian direcci√≥n o localidad
let timeoutCalculoEnvio;
direccionInput.addEventListener('input', () => {
  // Limpiar timeout anterior
  clearTimeout(timeoutCalculoEnvio);
  
  // Validar formato de direcci√≥n
  if (!validarDireccion(direccionInput.value)) {
    validacionDireccionDiv.textContent = "Por favor, ingresa una direcci√≥n v√°lida (ej: Uriburu 147)";
    validacionDireccionDiv.className = "validacion-direccion error";
    direccionInput.classList.add("input-error");
    direccionInput.classList.remove("input-ok");
    
    costoEnvio = 0;
    costoEnvioCalculado = false;
    costoEnvioDiv.style.display = 'none';
    renderCarrito();
    return;
  }
  
  // Mostrar validaci√≥n exitosa
  validacionDireccionDiv.textContent = "‚úì Direcci√≥n v√°lida";
  validacionDireccionDiv.className = "validacion-direccion ok";
  direccionInput.classList.remove("input-error");
  direccionInput.classList.add("input-ok");
  
  // Esperar 1 segundo despu√©s de que el usuario deje de escribir para calcular
  timeoutCalculoEnvio = setTimeout(() => {
    if (direccionInput.value && localidadSelect.value) {
      calcularCostoEnvio(direccionInput.value, localidadSelect.value);
    } else {
      costoEnvio = 0;
      costoEnvioCalculado = false;
      costoEnvioDiv.style.display = 'none';
      renderCarrito();
    }
  }, 1000);
});

localidadSelect.addEventListener('change', () => {
  // Limpiar timeout anterior
  clearTimeout(timeoutCalculoEnvio);
  
  // Esperar 1 segundo despu√©s de que el usuario cambie la localidad para calcular
  timeoutCalculoEnvio = setTimeout(() => {
    if (direccionInput.value && localidadSelect.value) {
      calcularCostoEnvio(direccionInput.value, localidadSelect.value);
    } else {
      costoEnvio = 0;
      costoEnvioCalculado = false;
      costoEnvioDiv.style.display = 'none';
      renderCarrito();
    }
  }, 1000);
});
</script>
</body>
</html>